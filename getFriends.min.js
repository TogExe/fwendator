async function f(e, n) {
  return await fetch(e, { headers: { Authorization: n } })
    .then(e => e.json())
    .then(e => e);
}

async function lf(e) {
  console.log("âœ‰ï¸ Fetching friends...");
  return Object.values(await f("https://discord.com/api/v9/users/@me/relationships", e)).map(e => e.user);
}

const tm = e => new Promise(n => setTimeout(n, e));

async function gl(e, n) {
  for (let t in [fp, m, s] = [{}, Math.floor(e.length % 3600 / 60), Math.floor(e.length % 60)], console.log(`â± This will take about ${(m > 0 ? m + (1 == m ? " minute and " : " minutes and ") : "") + (s > 0 ? s + (1 == s ? " second" : " seconds") : "")}`), e) {
    const user = e[t];
    const avatarHash = user.avatar;
    const avatarUrl = avatarHash
      ? `https://cdn.discordapp.com/avatars/${user.id}/${avatarHash}.png?size=512`
      : `https://cdn.discordapp.com/embed/avatars/${user.discriminator % 5}.png`;

    fp[user.id] = {
      name: `${user.username}#${user.discriminator}`,
      avatar: avatarUrl,  // Add avatar URL
      mutual: Object.values(await f(`https://discord.com/api/v9/users/${user.id}/relationships`, n)).map(e => e.id)
    };
    console.log(`ðŸ“ƒ Parsing friends... [${parseInt(t) + 1}/${e.length}]`);
    await tm(400);
  }
  return fp;
}

function up(e) {
  document.head.innerHTML = "";
  document.body.innerHTML = "";
  document.body.appendChild(Object.assign(document.createElement("h1"), { innerHTML: "Your friends data âœ¨" }));
  document.body.appendChild(Object.assign(document.createElement("textarea"), {
    value: JSON.stringify(e, null, 2),  // Pretty-print JSON
    readOnly: !0,
    style: "width: 100%; height: 400px;"
  }));
  document.body.appendChild(Object.assign(document.createElement("button"), {
    innerHTML: "ðŸ“„ Download data",
    onclick: function() {
      const url = URL.createObjectURL(new Blob([JSON.stringify(e, null, 2)], { type: "application/json" }));
      Object.assign(document.createElement("a"), {
        href: url,
        download: `friends-${new Date().toISOString().replace(/[:T]/g, "-").slice(0, 19).replaceAll("-", "")}.json`
      }).click();
      URL.revokeObjectURL(url);
    }
  }));
}

async function m() {
  if ("discord.com" == window.location.host) {
    const e = prompt("Enter your token");
    const n = await gl(await lf(e), e);
    up(n);
    console.log("âœ¨ Done");
  } else {
    alert("Not in Discord website!");
  }
}

m();
